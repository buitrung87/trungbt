apiVersion: 1

groups:
  - orgId: 1
    name: Docker Logs Alerts
    folder: Log Alerts
    interval: 1m

    rules:
      - uid: container-error-fatal-panic
        title: Container ERROR / FATAL / PANIC Logs
        condition: C

        data:
          - refId: A
            datasourceUid: loki
            relativeTimeRange:
              from: 300
              to: 0
            model:
              queryType: range
              expr: |
                topk by(container_name) (1,
                  sum by (container_name, log_level, log_message) (
                    count_over_time(
                      {container_name!=""}
                      |~ "(?i)error|fatal|panic"
                      | regexp "(?P<log_level>error|fatal|panic)"
                      | regexp "(?P<log_message>.*)"
                      [5m]
                    )
                  )
                )

          - refId: B
            datasourceUid: __expr__
            model:
              type: reduce
              reducer: last
              expression: A

          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
        
        for: 30s
        noDataState: OK
        execErrState: OK

        annotations:
          summary: "ðŸš¨ {{ $labels.log_level | toUpper }} log tá»« {{ $labels.container_name }}"
          description: "{{ $labels.log_message }}"

        labels:
          severity: warning
          alert_type: docker_logs

        notification_settings:
          receiver: TELEGRAM_LOG_TOPIC
          group_by: [container_name, log_level]
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
